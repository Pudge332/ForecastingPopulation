@echo off
echo Проверка целостности базы данных перед публикацией
echo.

:: Проверяем наличие файла базы данных
if not exist "Population.db" (
    echo ОШИБКА: Файл базы данных Population.db не найден!
    echo Убедитесь, что файл базы данных находится в текущей директории.
    pause
    exit /b 1
)

:: Проверяем, не заблокирован ли файл базы данных
echo Проверка доступности файла базы данных...
copy /b "Population.db" nul > nul 2>&1
if %errorlevel% neq 0 (
    echo ОШИБКА: Файл базы данных заблокирован другим процессом!
    echo Закройте все приложения, которые могут использовать базу данных, и повторите попытку.
    pause
    exit /b 1
)

:: Проверяем целостность базы данных с помощью sqlite3
echo Проверка целостности базы данных...

:: Проверяем наличие sqlite3.exe
where sqlite3 > nul 2>&1
if %errorlevel% neq 0 (
    echo ПРЕДУПРЕЖДЕНИЕ: Утилита sqlite3.exe не найдена в системе.
    echo Невозможно выполнить проверку целостности базы данных.
    echo Рекомендуется установить SQLite для полной проверки.
) else (
    :: Выполняем проверку целостности
    sqlite3 "Population.db" "PRAGMA integrity_check;"
    if %errorlevel% neq 0 (
        echo ОШИБКА: База данных повреждена!
        echo Рекомендуется восстановить базу данных из резервной копии.
        pause
        exit /b 1
    ) else (
        echo База данных прошла проверку целостности успешно.
    )
)

:: Проверяем наличие файлов журнала SQLite
if exist "Population.db-shm" (
    echo ПРЕДУПРЕЖДЕНИЕ: Обнаружен файл журнала Population.db-shm.
    echo Это может означать, что база данных не была корректно закрыта.
)

if exist "Population.db-wal" (
    echo ПРЕДУПРЕЖДЕНИЕ: Обнаружен файл журнала Population.db-wal.
    echo Это может означать, что база данных не была корректно закрыта.
)

echo.
echo Проверка завершена. База данных готова к публикации.
echo.
echo Рекомендуется создать резервную копию базы данных перед публикацией.
echo.

pause
